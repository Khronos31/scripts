#!/bin/bash
# Khronos | websh

URL="https://websh.jiro4989.com/api/shellgei"
FILE="-"
MODE="default"
code=""
images=""

usage(){
  echo "Usage: $0 -[rfh] [-p COMMAND] [-i IMAGE] [FILE]"
  echo "With no FILE, or when FILE is -, read standard input."
  echo "  -r : print raw response"
  echo "  -f : print response in readable format"
  echo "  -p COMMAND: read standard input and pass it to the standard input of COMMAND on the websh"
  echo "  -i IMAGE: upload IMAGE to websh"
  echo "  -h : display this help and exit"
}

while getopts rfp:i:h OPT; do
  case "$OPT" in
    "r") MODE="raw"
         ;;
    "f") MODE="format"
         ;;
    "p") MODE="pipe"
         code="\"echo $(base64 -w0)|base64 -d|$OPTARG\""
         ;;
    "i") images="$images,\"$(base64 -w0 "$OPTARG")\""
         ;;
    "h") usage
         exit 0
         ;;
    "?") usage
         exit 1
         ;;
  esac
done

shift $((OPTIND - 1))
if [ $# -ge 1 ]; then
  FILE="$1"
fi

images="${images:1}"

if [ "$MODE" != "pipe" ]; then
  code="$(cat "$FILE"|jq -Rs .)"
fi

data=$(
curl \
  -sS \
  -X POST \
  -H 'Content-Type: text/plain;charset=UTF-8' \
  -H 'Accept-Encoding: gzip, deflate' \
  -H 'Accept: */*' \
  -d '{"code":'"$code"',"images":['$images']}' \
  "$URL"
)

timestamp="$(date +%Y%m%d_%H%M%S)"

if [ "$MODE" = "raw" ]; then
  echo "$data"
  exit $(jq -r .status <<<"$data")
fi

sysmsg="$(jq -r .system_message <<<"$data")"

case "$MODE" in
  "default" | "pipe")
    jq -r .stdout <<<"$data"|head -c -1
    test -n "$sysmsg"&&echo "$sysmsg" >&2
    ;;
  "format")
    echo "[stdout]"
    jq -r .stdout <<<"$data"
    echo "[stderr]"
    jq -r .stderr <<<"$data"
    echo "[system message]"
    jq -r .system_message <<<"$data"
    ;;
esac

num=$(($(jq '.images |length' <<<"$data")-1))
for i in $(seq -w 0000 $num);do
  tmp="$(mktemp -p .)"
  jq -r ".images[$i].image" <<<"$data"|base64 -d >$tmp
  type=($(file -b $tmp))
  mv "$tmp" "websh-$timestamp-$i.${type[0]}"
done

exit $(jq -r .status <<<"$data")
